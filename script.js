// *****************************************************************
// *** 1. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ ID ‡πÅ‡∏•‡∏∞ GID ‡∏Ç‡∏≠‡∏á Google Sheet ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ***
// *****************************************************************
const YOUR_SHEET_ID = "534811997"; // <--- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
const YOUR_GID = "Honkaistarrail"; // <--- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Sheet ‡πÅ‡∏£‡∏Å)
// *****************************************************************

// ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô JSON
// tqx=out:json ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ Google ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô JSON
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${534811997}/gviz/tq?tqx=out:json&gid=${Honkaistarrail}`;

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°
async function checkStatus() {
    const idInput = document.getElementById('statusId');
    // ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
    const trackingId = idInput.value.trim().toUpperCase(); 
    const resultDiv = document.getElementById('result');

    resultDiv.innerHTML = '<p style="color: #007bff;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...</p>';

    if (trackingId === "") {
        resultDiv.innerHTML = '<p style="color: red;">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏∞</p>';
        return;
    }

    try {
        const response = await fetch(SHEET_URL);
        
        // Google Sheet ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á
        const text = await response.text();
        
        // ‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON ‡∏≠‡∏≠‡∏Å (‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô /*O_o*/ ‡πÅ‡∏•‡∏∞‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö‡∏õ‡∏¥‡∏î)
        const jsonText = text.replace(/^google\.visualization\.Query\.setResponse\({/i, '{').replace(/\);$/, '');
        
        // ‡πÅ‡∏õ‡∏•‡∏á Text ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Object JSON
        const dataObject = JSON.parse(jsonText);
        
        // ‡∏î‡∏∂‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const rows = dataObject.table.rows;

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å
        const statusData = findStatus(rows, trackingId);
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        displayStatus(statusData, trackingId, resultDiv);

    } catch (error) {
        console.error('Fetch/Parse Error:', error);
        resultDiv.innerHTML = '<p style="color: #dc3545;">üö® ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ID/GID ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå</p>';
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
function findStatus(rows, trackingId) {
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1 (index 0 ‡∏Ñ‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö)
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i].c;
        
        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A (index 0) ‡∏Ñ‡∏∑‡∏≠ '‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°'
        const idFromSheet = row[0]?.v ? String(row[0].v).toUpperCase() : '';
        
        if (idFromSheet === trackingId) {
            // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B (index 1) ‡∏Ñ‡∏∑‡∏≠ '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'
            const status = row[1]?.v || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
            // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå C (index 2) ‡∏Ñ‡∏∑‡∏≠ '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'
            const detail = row[2]?.v || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°';
            
            return {
                id: trackingId,
                status: status,
                detail: detail
            };
        }
    }
    return null; // ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
function displayStatus(data, trackingId, resultDiv) {
    if (!data) {
        resultDiv.innerHTML = `
            <p style="color: #6c757d; font-weight: bold;">‚ö´ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™ ${trackingId} ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
            <p style="color: #6c757d;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
        `;
        return;
    }

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ
    let statusColor;
    if (data.status.includes("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥") || data.status.includes("‡∏à‡∏±‡∏î‡∏™‡πà‡∏á")) {
        statusColor = "#28a745"; // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
    } else if (data.status.includes("‡∏Å‡∏≥‡∏•‡∏±‡∏á") || data.status.includes("‡∏£‡∏≠")) {
        statusColor = "#ffc107"; // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
    } else if (data.status.includes("‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò") || data.status.includes("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å")) {
        statusColor = "#dc3545"; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
    } else {
        statusColor = "#007bff"; // ‡∏™‡∏µ‡∏ü‡πâ‡∏≤
    }

    resultDiv.innerHTML = `
        <h3>‚úÖ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h3>
        <p><strong>‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°:</strong> ${data.id}</p>
        <p style="color: ${statusColor}; font-weight: bold;">
            **‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:** ${data.status}
        </p>
        <p><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> ${data.detail}</p>
    `;
}
